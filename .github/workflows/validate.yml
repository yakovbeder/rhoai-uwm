name: Validate Kustomize Manifests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.1.1"

      - name: Validate Kustomize overlays
        run: |
          echo "Validating Kustomize overlays..."
          kustomize build rhoai-uwm-grafana-kustomize/overlays/rhoai-uwm-user-grafana-app/infrastructure-rbac/ > /dev/null
          kustomize build rhoai-uwm-grafana-kustomize/overlays/rhoai-uwm-user-grafana-app/grafana-instance/ > /dev/null
          kustomize build rhoai-uwm-grafana-kustomize/overlays/rhoai-uwm-user-grafana-app/dashboards/ > /dev/null
          echo "✓ Kustomize overlays validated"

      - name: Validate base resources
        run: |
          echo "Validating base resources..."
          kustomize build common/base/rbac/ > /dev/null
          kustomize build common/base/core/ > /dev/null
          kustomize build common/base/auth/ > /dev/null
          kustomize build common/base/dashboards/ > /dev/null
          echo "✓ Base resources validated"

      - name: Check YAML syntax
        run: |
          echo "Checking YAML syntax..."
          find . -name "*.yaml" -o -name "*.yml" | while read -r file; do
            # Skip if file is empty or doesn't exist
            [ -s "$file" ] || continue
            # Try to parse with Python's yaml module (basic syntax check)
            # Use safe_load_all to support multi-document YAML files (--- separators)
            python3 -c "
          import yaml, sys
          with open('$file') as f:
              list(yaml.safe_load_all(f))
          " || {
              echo "❌ YAML syntax error in: $file"
              exit 1
            }
          done
          echo "✓ All YAML files have valid syntax"
